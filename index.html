<!doctype html>
<!-- <html manifest="cache.manifest"> -->
<html>
<head>
    <title>Scottish Metrical Psalms</title> 
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--<link rel="stylesheet" href="//code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css">-->
    <link rel="stylesheet" href="psalms.css">

    <style type="text/css">
    /*
    	DEBUG
    */

    div[data-role=page] {
    	display: none;
    }



    	.ui-btn {
    		padding: 0;
    		margin-top: 4px;
    	}
		.ui-btn-inner {
			padding: .4em 10px;
		}
    </style>
    
    <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
    <!-- <script src="//code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.2.1/lodash.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/knockout/2.3.0/knockout-min.js"></script>

    <script src="psalms.data.js"></script>
    <script src="psalms.js"></script>

	<!--
		Resources:
			http://stackoverflow.com/questions/4165836/javascript-scale-text-to-fit-in-fixed-div
			http://stackoverflow.com/questions/5849173/multiple-buttons-on-right-hand-side-of-header
	-->
</head>
<body>

	<!-- Psalm Selector -->
    <div id='psalm-select-page' class="page">
        <div class="page-header">
            <h1>Psalm Selection</h1>
        </div>
 
        <div class="page-content" data-bind="foreach: numbers">
        	<div class="psalm-number-button">	
				<a data-bind="click: $parent.selectPsalm" href="javascript:void(0);">
					<span data-bind="text: $data"></span>
				</a>
			</div>
        </div>
    </div>


	<!-- Psalm Content -->
    <div id='psalm-content-page' class="page">
    	<div class="page-header">
    		<a href="javascript:void(0);" class="button float-left" data-bind="click: backToSelectPsalm">Back</a>

            <h1>Psalm <span id="psalm-header-number" data-bind="text: psalmNumber"></span></h1>

		    <fieldset 	id="duel-version-selector" 
		    			data-bind="visible: showDuelVersionButtons"
	    				data-role="controlgroup" 
	    				data-type="horizontal" 
	    				class="ui-btn-right">
	         	<input data-bind="click: selectVersion1, checked: currentSelectedVersion" data-mini="true" type="radio" name="radio-choice-2" id="version1" value="choice-1" />
	         	<label for="version1">Ver. 1</label>

	         	<input data-bind="click: selectVersion2, checked: currentSelectedVersion" data-mini="true" type="radio" name="radio-choice-2" id="version2" value="choice-2" />
	         	<label for="version2">Ver. 2</label>
		    </fieldset> 

		    <a 	id="psalm119PartSelector" 
		    	data-bind="visible: showPsalm119Button" 
		    	href="#psalm119-part-selector" 
		    	class="float-right" 
		    	data-rel="dialog" 
		    	data-transition="flip">Select Part...</a>
        </div>
 
 		<div class='page-content'>
	        <div id="psalm-contents" class="psalm-contents"
	        	 data-bind=" attr: { 'data-psalm-number' : psalmNumber },
	        	 			style: { fontSize: fontSize },
	        	 			 html: psalmText">
	        </div>
        </div>
    </div>

	<!-- Psalm 119 Version Selector -->
    <div id="psalm119-part-selector" data-role="page">
		<div data-role="header">
			<h2>Select Psalms 119 Part</h2>
		</div>
		<div data-role="content">
			<ul id="psalm119PartList" data-role="listview">
				<li data-bind="click: selectPsalm119Part" data-part-no="1">Part 1 - Verses 1-8</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="2">Part 2 - Verses 9-16</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="3">Part 3 - Verses 17-24</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="4">Part 4 - Verses 25-32</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="5">Part 5 - Verses 33-40</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="6">Part 6 - Verses 41-48</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="7">Part 7 - Verses 49-56</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="8">Part 8 - Verses 57-64</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="9">Part 9 - Verses 65-72</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="10">Part 10 - Verses 73-80</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="11">Part 11 - Verses 81-88</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="12">Part 12 - Verses 89-96</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="13">Part 13 - Verses 97-104</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="14">Part 14 - Verses 105-112</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="15">Part 15 - Verses 113-120</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="16">Part 16 - Verses 121-128</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="17">Part 17 - Verses 129-136</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="18">Part 18 - Verses 137-144</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="19">Part 19 - Verses 145-152</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="20">Part 20 - Verses 153-160</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="21">Part 21 - Verses 161-168</li>
				<li data-bind="click: selectPsalm119Part" data-part-no="22">Part 22 - Verses 169-176</li>
			</ul>	
		</div>
    </div>


	<!-- Page Script -->
    <script>

    	

		function determineOptimalWidth(text) {
			return determineOptimalWidth_Old(text);
		}

		function determineOptimalWidth_New(text) {

		}

    	function determineOptimalWidth_Old(text) {
    		var tryCounter = 0;

    		// Ensure We have info and Resizer in Page
    		var currentPage = $("#psalm-contents");
    		//var psalmContents = currentPage.html("");

    		var desiredWidth = currentPage.width() - 25;
    		var resizer = currentPage.find(".resizer");
			
			if (resizer.length === 0) {
				currentPage.append('<span class="resizer" style="visibility: hidden"></span>')
				resizer = currentPage.find(".resizer");
			}

			// Setup Resizer for Calculation
			resizer.html('');
			resizer.css('font-size', '5');
			resizer.html(text);

			var size = 5;
			var tooSmall = (resizer.width() > desiredWidth) === false;

			if (tooSmall) {
				// Too small, enlarge
				while(resizer.width() < desiredWidth) {
					size = parseInt(resizer.css("font-size"), 10);
					size += 1;
				  	resizer.css("font-size", size);

				  	if(size > 200) {
				  		if(console && console.error) {
				  			console.error("cannot determine correct size of font required");
				  		}
				  		break;
				  	}

				  	tryCounter += 1;

				  	if (tryCounter > 1000) {
				  		break;
				  	}
				}
			} else {
				// Too big, shrink
				while(resizer.width() > desiredWidth) {
				  	size = parseInt(resizer.css("font-size"), 10);
				  	size -= 1;
				  	resizer.css("font-size", size);

				  	if(size > 200) {
				  		if(console && console.error) {
				  			console.error("cannot determine correct size of font required");
				  		}
				  		break;
				  	}

				  	tryCounter += 1;

				  	if (tryCounter > 1000) {
				  		break;
				  	}
				}
			}

			size -= 2;

			resizer.html('');

			return size;
    	}


	    	var ViewModel = function() {
	    		var vm = this;

	    		this.psalmNumbers = this.numbers = ko.observableArray(_.range(1,151));
	    		this.psalmNumber = ko.observable();
	    		this.psalmVersion = ko.observable(1);
	    		this.psalmText = ko.observable();

	    		this.textSize = ko.observable(5);
	    		this.fontSize = ko.computed(function() {
	    			return vm.textSize() + 'px';
	    		});

	    		this.showDuelVersionButtons = ko.observable(false);
	    		this.showPsalm119Button = ko.observable(false);

	    		this.currentWidth = ko.observable($(window).width());

	    		this.selectPsalm = function() {
	    			var number = this;

	    			vm.psalmNumber(number);
	    			vm.psalmVersion(1);

					cs.showPage("psalm-content-page", function() {
						vm.bindPsalmData();
					});
	    		},

	    		this.backToSelectPsalm = function() {
	    			$(window).off("resize", this.calculateFontSizeOnResize);

	    			cs.showPage("psalm-select-page");
	    		}

	    		this.bindPsalmData = function() {
	    			vm.psalmText(" ");

	    			$(window).off("resize", this.calculateFontSizeOnResize);

	    			// Get Specific Version
					var text =  cs.psalm.getPsalmText(
						vm.psalmNumber(), 
						vm.psalmVersion(), 
						true /* format */
					);

					var versions = cs.psalm.psalmVersions(vm.psalmNumber());
					var size = determineOptimalWidth(text);

					// Version Buttons
					// vm.showPsalm119Button(false);
					// vm.showDuelVersionButtons(false);

	    			//if (versions === 2) {	    				
	    			//	vm.showDuelVersionButtons(true);

					//	$("[type=radio]").checkboxradio('refresh')

						//var radioButtons = $("#duel-version-selector [type=radio]");
						//if (radioButtons.data("mobileCheckboxradio") != null) {
					//		radioButtons.checkboxradio("refresh");
					//	}

						//$("#duel-version-selector").find("input[type='radio']").prop("checked",false).checkboxradio("refresh");
	    				//$("#duel-version-selector").find("input[type='radio']:first").prop("checked",true).checkboxradio("refresh");
	    			//} else if (versions === 22) {
					//	vm.showPsalm119Button(true);
	    			//}

					// Bind Text and font size
					vm.textSize(size);
					vm.psalmText(text);
					//vm.psalmVersion(vm.psalmVersion());

					$(window).on("resize", this.calculateFontSizeOnResize);
	    		}

	    		this.currentSelectedVersion = ko.computed(function() {
	    			// Will just ignore that we might not be on a psalm
	    			// with multiple versions or on psalm 119 as 
	    			// that stuff won't be visible anyway!
	    			return 'choice-' + this.psalmVersion();
	    		}, this);

	    		this.selectVersion1 = function() {
	    			vm.psalmVersion(1);
	    			vm.bindPsalmData();

	    			return false;
	    		}

	    		this.selectVersion2 = function() {
	    			vm.psalmVersion(2);
	    			vm.bindPsalmData();

	    			return false;
	    		}

	    		this.selectPsalm119Part = function(vm, event) {
					var version = parseInt($(event.target).attr('data-part-no'), 10);

					// We have to trigger the bind after the 
					// main page loads or we get infinite loops
					// in the width calculation routine....
					$(document).one('pageshow', function() {
						vm.bindPsalmData();
					});

					$( "#psalm119-part-selector").dialog( "close" );

					vm.psalmVersion(version);

					return false;
	    		},

	    		this.calculateFontSizeOnResize = _.debounce(function() {
	    			var contentElement = $("#psalm-contents");

	    			if (contentElement.is(":visible") && $(window).width() !== vm.currentWidth()) {
	    				// vm.currentWidth($(window).width());
	    				// var newSize = determineOptimalWidth(contentElement.html());	
	    				// contentElement.css('font-size', newSize);
	    				vm.bindPsalmData();
	    			}
	    		}, 400);
	    	};

	    	var myViewModel = new ViewModel();
	    	ko.applyBindings(myViewModel);


    	$(function() {
    		// Psalm Selector Buttons
    		//generatePsalmButtons();
    		
	    	// Psalm Numbers
	    	var psalmNumbersContainer = $("#psalm-numbers");

	    	// Content Area
	    	var psalmContentContainer = $("#psalm-contents"),
	    		psalmHeaderNumber = $("#psalm-header-number");

    		var currentWidth = $(window).width();

    		// On Resize of the viewport figure out 
    		// the new font-size...
    		function calculateFontSizeOnResize() {
				var contentElement = psalmContentContainer;
    			if (contentElement.is(":visible") && $(window).width() !== currentWidth) {
    				currentWidth = $(window).width();
    				var newSize = determineOptimalWidth(contentElement.html());	
    				contentElement.css('font-size', newSize);
    			}
    		}; 

    		//
    		//$(document).on( "swipeleft", "#psalms-contents", function() {
    		//	var currentNo = myViewModel.psalmNumber();
    		//	if (currentNo > 1) {
			//		myViewModel.psalmNumber(--currentNo);
			//		myViewModel.psalmVersion(1);
			//		myViewModel.bindPsalmData();
    		//	}
    		//});
//
    		//$(document).on( "swiperight", "#psalms-contents", function() {
    		//	var currentNo = myViewModel.psalmNumber();
    		//	if (currentNo < 150) {
			//		myViewModel.psalmNumber(++currentNo);
			//		myViewModel.psalmVersion(1);
			//		myViewModel.bindPsalmData();
    		//	}
    		//});
    	});

		// Check if a new cache is available on page load.
		window.addEventListener('load', function(e) {

		  window.applicationCache.addEventListener('updateready', function(e) {
		    if (window.applicationCache.status == window.applicationCache.UPDATEREADY) {
		      // Browser downloaded a new app cache.
		      if (confirm('A new version of this site is available. Load it?')) {
		        window.location.reload();
		      }
		    } else {
		      // Manifest didn't changed. Nothing new to server.
		    }
		  }, false);

		}, false);



//TODO: 
//Use this for versionsn.
//<span style="display: block;position: relative; width: 100%; height: 100%; clear: both"><span style="display: block; font-size: 0.7em; position: absolute; bottom: 0; right: 0;margin: -10px -7px ;padding:  0;">2</span></span>





		// Show the first page
		cs.showPage("#psalm-select-page");
    </script>
</body>
</html>